from collections.abc import Sequence
from typing import Any, LiteralString, NotRequired, TypedDict

from pydantic_core import ErrorDetails, InitErrorDetails, PydanticCustomError
from pydantic_core import ValidationError as PydanticValidationError


class QuoinError(Exception):
    """Base exception for all Quoin application errors."""

    def __init__(
        self,
        message: str,
        status_code: int = 500,
        headers: dict[str, str] | None = None,
    ) -> None:
        """Initialize QuoinError."""
        super().__init__(message)
        self.message = message
        self.status_code = status_code
        self.headers = headers


class ValidationError(TypedDict):
    """Pydantic validation error shape."""

    loc: tuple[int | str, ...]
    msg: LiteralString
    type: LiteralString
    input: Any
    ctx: NotRequired[dict[str, Any]]
    url: NotRequired[str]


class QuoinRequestValidationError(QuoinError):
    """Request validation error (wraps Pydantic ValidationError)."""

    def __init__(self, errors: Sequence[ValidationError]) -> None:
        """Initialize QuoinRequestValidationError."""
        self._errors = errors

    def errors(self) -> list[ErrorDetails]:
        """Convert to Pydantic error format."""
        pydantic_errors: list[InitErrorDetails] = []
        for error in self._errors:
            pydantic_errors.append(
                {
                    "type": PydanticCustomError(error["type"], error["msg"]),
                    "loc": error["loc"],
                    "input": error["input"],
                }
            )
        pydantic_error = PydanticValidationError.from_exception_data(
            self.__class__.__name__, pydantic_errors
        )
        return pydantic_error.errors()


class InternalServerError(QuoinError):
    """Internal Server Error."""

    def __init__(
        self,
        message: str = "Internal Server Error",
        headers: dict[str, str] | None = None,
    ) -> None:
        """Initialize InternalServerError."""
        super().__init__(message, status_code=500, headers=headers)


class NotFoundError(QuoinError):
    """Resource Not Found."""

    def __init__(
        self,
        message: str = "Not Found",
        headers: dict[str, str] | None = None,
    ) -> None:
        """Initialize NotFoundError."""
        super().__init__(message, status_code=404, headers=headers)


class ConflictError(QuoinError):
    """Resource Conflict."""

    def __init__(
        self,
        message: str = "Conflict",
        headers: dict[str, str] | None = None,
    ) -> None:
        """Initialize ConflictError."""
        super().__init__(message, status_code=409, headers=headers)


class BadRequestError(QuoinError):
    """Bad Request."""

    def __init__(
        self,
        message: str = "Bad Request",
        headers: dict[str, str] | None = None,
    ) -> None:
        """Initialize BadRequestError."""
        super().__init__(message, status_code=400, headers=headers)


class ForbiddenError(QuoinError):
    """Forbidden."""

    def __init__(
        self,
        message: str = "Forbidden",
        headers: dict[str, str] | None = None,
    ) -> None:
        """Initialize ForbiddenError."""
        super().__init__(message, status_code=403, headers=headers)
